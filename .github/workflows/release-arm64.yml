name: Build and Push ARM64 Docker Image (Manual)

on:
  workflow_dispatch:

jobs:
  build-arm64-image-manual:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM emulation
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: network=host
          buildkitd-flags: --allow-insecure-entitlement security.insecure --allow-insecure-entitlement network.host
          platforms: linux/arm64

      - name: Upgrade xgboost for ARM64
        run: |
          sed -i 's/xgboost = "[^"]*"/xgboost = "1.6.0"/' pyproject.toml

      - name: Install unixODBC
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc

      - name: Download dependencies
        run: |
          pip install -e .
          pip install -r requirements.txt || true
          python download_deps.py

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ragflow_deps image (ARM64)
        run: |
          repo_name=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker buildx build --builder default --platform linux/arm64 -f Dockerfile.deps -t ghcr.io/${repo_name}/ragflow_deps:arm64 --push .

      - name: Build and push ragflow main image (ARM64)
        run: |
          repo_name=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker buildx build --builder default --platform linux/arm64 -f Dockerfile -t ghcr.io/${repo_name}/ragflow:nightly-arm64 --push .
